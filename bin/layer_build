#!/usr/bin/env ruby
# frozen_string_literal: true

require 'fileutils'

require_relative '../lib/twenty48'

include Twenty48

def build(board_size:, max_exponent:, max_depth:, max_states:)
  # Note: exact discount value doesn't matter for build step.
  discount = 0.95
  folder = File.join(Storage::LAYER_STATES_PATH, Storage.build_basename(
    board_size: board_size,
    max_exponent: max_exponent,
    max_depth: max_depth
  ))
  FileUtils.mkdir_p folder
  valuer = NativeValuer.create(
    board_size: board_size,
    max_exponent: max_exponent,
    max_depth: max_depth,
    discount: discount
  )
  layer_builder = NativeLayerBuilder.create(board_size, folder, valuer)
  layer_builder.build(max_states) do |layer_pathname, num_states|
    puts format('%s: %d states', layer_pathname, num_states)
  end
end

build(
  board_size: 2,
  max_exponent: 5,
  max_depth: 0,
  max_states: 1024
)

# build(
#   board_size: 3,
#   max_exponent: 11,
#   max_lose_depth: 0,
#   max_win_depth: 0,
#   max_states: 60 * 1024**2
# )

# build(
#   board_size: 4,
#   max_exponent: 11,
#   max_lose_depth: 0,
#   max_win_depth: 0,
#   max_states: 1.3e9.to_i
# )
